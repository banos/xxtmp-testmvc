/*global riot, tobuyStorage */
<tobuy>
	<section class="tobuyapp">
		<header class="header">
			<h1>tobuys</h1>
			<input class="new-tobuy" autofocus autocomplete="off" placeholder="What needs to be done?" onkeyup={ addTodo }>
		</header>
		<section class="main" show={ tobuys.length }>
			<input class="toggle-all" type="checkbox" checked={ allDone } onclick={ toggleAll }>
			<ul class="tobuy-list">
				<li riot-tag="tobuyitem" class="tobuy { completed: t.completed, editing: t.editing }"
						each={ t, i in filteredTodos() } tobuy={ t } parentview={ parent }></li>
			</ul>
		</section>
		<footer class="footer" show={ tobuys.length }>
			<span class="tobuy-count">
				<strong>{ remaining }</strong> { remaining === 1 ? 'item' : 'items' } left
			</span>
			<ul class="filters">
				<li><a class={ selected: activeFilter=='all' } href="#/all">All</a></li>
				<li><a class={ selected: activeFilter=='active' } href="#/active">Active</a></li>
				<li><a class={ selected: activeFilter=='completed' } href="#/completed">Completed</a></li>
			</ul>
			<button class="clear-completed" onclick={ removeCompleted } show={ tobuys.length > remaining }>
				Clear completed</button>
		</footer>
	</section>
	<footer class="info">
		<p>Double-click to edit a tobuy</p>
		<p>Written by <a href="http://github.com/txchen">Tianxiang Chen</a></p>
		<p>Part of <a href="http://tobuymvc.com">TodoMVC</a></p>
	</footer>
	<script>
	'use strict';

	var ENTER_KEY = 13;
	var self = this;
	self.tobuys = opts.data || [];

	riot.route.exec(function(base, filter) {
		self.activeFilter = filter || 'all';
	});

	self.on('update', function() {
		self.remaining = self.tobuys.filter(function(t) {
			return !t.completed;
		}).length;
		self.allDone = self.remaining === 0;
		self.saveTodos();
	});

	saveTodos() {
		tobuyStorage.save(self.tobuys);
	};

	filteredTodos() {
		if (self.activeFilter === 'active') {
			return self.tobuys.filter(function(t) {
				return !t.completed;
			});
		} else if (self.activeFilter === 'completed') {
			return self.tobuys.filter(function(t) {
				return t.completed;
			});
		} else {
			return self.tobuys;
		}
	};

	addTodo(e) {
		if (e.which === ENTER_KEY) {
			var value = e.target.value && e.target.value.trim();
			if (!value) {
				return;
			}
			self.tobuys.push({ title: value, completed: false });
			e.target.value = '';
		}
	};

	removeTodo(tobuy) {
		self.tobuys.some(function (t) {
			if (tobuy === t) {
				self.tobuys.splice(self.tobuys.indexOf(t), 1);
			}
		});
	};

	toggleAll(e) {
		self.tobuys.forEach(function (t) {
			t.completed = e.target.checked;
		});
		return true;
	};

	removeCompleted() {
		self.tobuys = self.tobuys.filter(function(t) {
			return !t.completed;
		});
	};

	riot.route(function(base, filter) {
		self.activeFilter = filter;
		self.update();
	});
	</script>
</tobuy>

<tobuyitem>
	<div class="view">
		<input class="toggle" type="checkbox" checked={ opts.tobuy.completed } onclick={ toggleTodo }>
		<label ondblclick={ editTodo }>{ opts.tobuy.title }</label>
		<button class="destroy" onclick={ removeTodo }></button>
	</div>
	<input name="tobuyeditbox" class="edit" type="text" onblur={ doneEdit } onkeyup={ editKeyUp }>
	<script>
	'use strict';

	var ENTER_KEY = 13;
	var ESC_KEY = 27;
	var self = this;
	opts.tobuy.editing = false;

	toggleTodo() {
		opts.tobuy.completed = !opts.tobuy.completed;
		opts.parentview.saveTodos();
		return true;
	};

	editTodo() {
		opts.tobuy.editing = true;
		self.tobuyeditbox.value = opts.tobuy.title;
	};

	removeTodo() {
		opts.parentview.removeTodo(opts.tobuy);
	};

	doneEdit() {
		if (!opts.tobuy.editing) {
			return;
		}
		opts.tobuy.editing = false;
		var enteredText = self.tobuyeditbox.value && self.tobuyeditbox.value.trim();
		if (enteredText) {
			opts.tobuy.title = enteredText;
			opts.parentview.saveTodos();
		} else {
			self.removeTodo();
		}
	};

	editKeyUp(e) {
		if (e.which === ENTER_KEY) {
			self.doneEdit();
		} else if (e.which === ESC_KEY) {
			self.tobuyeditbox.value = opts.tobuy.title;
			self.doneEdit();
		}
	};

	self.on('update', function() {
		if (opts.tobuy.editing) {
			opts.parentview.update();
			self.tobuyeditbox.focus();
		}
	});
	</script>
</tobuyitem>
